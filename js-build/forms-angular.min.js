/*! forms-angular 2013-05-17 */
"use strict";var formsAngular=angular.module("formsAngular",["ui"]);formsAngular.controller("BaseCtrl",["$scope","$routeParams","$location","$http","$filter",function(e,n,t,r,a){function i(e){var n=e.split("."),t=[n[0]];return n.length>1&&t.push(n.slice(1).join(".")),t}function o(e,n,t){var r=i(e);if(r.length>1)s(r[1],n[r[0]],t);else if(n[r[0]]){var a=n[r[0]];n[r[0]]=t("Object"==typeof a?a.x:a)}}function s(e,n,t){if(void 0!==n)if($.isArray(n))for(var r=0;n.length>r;r++)o(e,n[r],t);else o(e,n,t)}function l(e,n,t,r){if(e.array){for(var a=[],i=0;n.length>i;i++)a.push({x:C(n[i],r,t,e.name)});return a}return C(n,r,t,e.name)}function c(e,n,t,r){if(e.array){for(var a=[],i=0;n.length>i;i++)a.push(k(n[i].x,t,r,e.name));return a}return k(n,t,r,e.name)}var u={};e.record={},e.formSchema=[],e.panes=[],e.listSchema=[],e.recordList=[],e.dataDependencies={},e.select2List=[],e.location=t.$$path.split("/");var d=e.location.length,f=e.location[d-1];e.newRecord=e.newRecord||"new"===f,n.model?(e.modelName=n.model,e.formName=n.form,e.id=n.id):(e.modelName=e.location[1],e.newRecord?4===d&&(e.formName=e.location[2]):5===d?(e.formName=e.location[2],e.id=e.location[3]):e.id=e.location[2]),e.formPlusSlash=e.formName?e.formName+"/":"",e.modelNameDisplay=a("titleCase")(e.modelName);var p=function(e,n){return e.id.replace(/\./g,"_")+n},m=function(n,a,i){var o;if(a.caster&&(n.array=!0,a=a.caster,$.extend(i,a.options)),"String"==a.instance)i.enum?(n.type="select",n.select2?(i.required&&e.$watch("record."+n.name,function(e){e?$("#cg_"+n.id).removeClass("fng-invalid-required"):$("#cg_"+n.id).addClass("fng-invalid-required")},!0),e["select2"+n.name]={allowClear:!i.required,query:function(e){for(var n={results:[]},t=e.term.toUpperCase(),r=0;i.enum.length>r;r++)-1!==i.enum[r].toUpperCase().indexOf(t)&&n.results.push({id:r,text:i.enum[r]});e.callback(n)}},_.extend(e["select2"+n.name],n.select2),n.select2.s2query="select2"+n.name,e.select2List.push(n.name)):(n.options=p(n,"Options"),e[n.options]=i.enum)):n.type||(n.type="text");else if("ObjectID"==a.instance)n.type="select",n.select2&&e.select2List.push(n.name),n.select2&&n.select2.fngAjax?(o="ajax"+n.name.replace(/\./g,""),e[o]={allowClear:!i.required,minimumInputLength:2,initSelection:function(e,a){r.get("api/"+i.ref+"/"+e.val()+"/list").success(function(r){r.success===!1&&t.path("/404");var i={id:e.val(),text:r.list};u[n.name]=i,a(i)}).error(function(){t.path("/404")})},ajax:{url:"/api/search/"+i.ref,data:function(e,n){return{q:e,page_limit:10,page:n}},results:function(e){return{results:e.results,more:e.moreCount>0}}}},_.extend(e[o],n.select2),n.select2.fngAjax=o):(n.options=p(n,"Options"),n.ids=p(n,"_ids"),O(i.ref,n));else if("Date"==a.instance)n.type="text",n.add="ui-date ui-date-format";else if("boolean"==a.instance)n.type="checkbox";else{if("Number"!=a.instance)throw Error("Field "+n.name+" is of unsupported type "+a.instance);n.type="number"}return i.required&&(n.required=!0),n},h=function(e,n,t){return n.name=t+e,n.id=n.id||"f_"+t+e,n.label=null==(n.hasOwnProperty("label")&&n.label)?"":n.label||a("titleCase")(e),n},v=function(e,n,t){var r=n||{hidden:!0};r.hidden||("object"==typeof r?(r.name=t,e.push(r)):e.push({name:t}))},g=function(e,n,t,r){if(t){for(var a=0,i=t.length;i>a;a++)if("text"==t[a].type){n.push({name:t[a].name});break}0===n.length&&0!==t.length&&n.push({name:t[0].name})}if(0===n.length){for(var o in r)if("_id"!==o&&r.hasOwnProperty(o)){n.push({name:o});break}if(0===n.length)throw Error("Unable to generate a title for "+e)}},b=function(n,t){function r(n){var r=n;return"string"==typeof n&&"$"===n.slice(0,1)&&(r=e.getListData(t,n.slice(1))),r}var a,i=r(n.lhs),o=r(n.rhs);switch(n.comp){case"eq":a=i===o;break;case"ne":a=i!==o;break;default:throw Error("Unsupported comparator "+n.comp)}return a},y=function(n,t){function r(n){if("string"==typeof n&&"$"===n.slice(0,1)){var r=n.slice(1),i=e.dataDependencies[r]||[];i.push(t),e.dataDependencies[r]=i,a+=1}}var a=0,i=!0;return n&&(r(n.lhs),r(n.rhs),0!==a||b(n)||(i=!1)),i};e.getListData=function(n,t){for(var r=t.split("."),a=0;r.length>a;a++)void 0!==n&&(n=n[r[a]]);return n&&-1!==e.select2List.indexOf(r[a-1])&&(n=n.text),void 0===n&&(n=""),n},e.updateDataDependentDisplay=function(n,t,r){for(var a in e.dataDependencies)if(e.dataDependencies.hasOwnProperty(a)&&(r||n[a]!=t[a]))for(var i=e.dataDependencies[a],o=0;i.length>o;o+=1)for(var s=i[o],l=0;e.formSchema.length>l;l+=1)if(e.formSchema[l].id===s){var c=$("#cg_"+s);b(e.formSchema[l].showIf,n)?c.show():c.hide()}};var w=function(n,t,r,a,i,o){function s(n,t){var r=angular.copy(n),a=_.find(e.panes,function(e){return e.title===r});if(!a){var i=!1;if(0===e.panes.length)if(e.formSchema.length>0){e.panes.push({title:"Main",content:[],active:!0}),a=e.panes[0];for(var o=0;e.formSchema.length>o;o++)a.content.push(e.formSchema[o])}else i=!0;a=e.panes[e.panes.push({title:r,content:[],active:i})-1]}a.content.push(t)}for(var l in t)if("_id"!==l&&t.hasOwnProperty(l)){var c=t[l],u=c.options||{},d=u.form||{};if(!d.hidden||r&&e.formName)if(c.schema){if(o&&r){var f=[];w("Nested "+l,c.schema,f,null,l+".",!0);var p=h(l,d,i);p.schema=f,d.pane&&s(d.pane,p),r.push(p)}}else{if(r){var b=h(l,d,i);if(y(b.showIf,b.id)){var $=m(b,c,u);$.pane&&s($.pane,$),r.push($)}}a&&v(a,u.list,l)}}a&&0===a.length&&g(n,a,r,t)};r.get("api/schema/"+e.modelName+(e.formName?"/"+e.formName:"")).success(function(a){if(w("Main "+e.modelName,a,e.formSchema,e.listSchema,"",!0),e.id||e.newRecord)e.$watch("record",function(n,t){e.updateDataDependentDisplay(n,t,!1)},!0),e.id&&r.get("api/"+e.modelName+"/"+e.id).success(function(n){n.success===!1&&t.path("/404"),u=N(e.formSchema,n,0),e.cancel()}).error(function(){t.path("/404")});else{var i=n.f?"?f="+n.f:"";r.get("api/"+e.modelName+i).success(function(n){e.recordList=n}).error(function(){t.path("/404")})}}).error(function(){t.path("/404")}),e.cancel=function(){e.record=angular.copy(u)};var x=function(e,n){if(-1!==[200,400].indexOf(n)){var t="";for(var r in e.errors)if(e.errors.hasOwnProperty(r)){switch(t+="<li><b>"+a("titleCase")(r)+": </b> ",e.errors[r].type){case"enum":t+="You need to select from the list of values";break;default:t+=e.errors[r].message}t+="</li>"}t=t.length>0?e.message+"<br /><ul>"+t+"</ul>":e.message||"Error!  Sorry - No further details available.",S(t)}else S(n+" "+JSON.stringify(e))},S=function(n,t){e.alertTitle=t?t:"Error!",e.errorMessage=n};e.dismissError=function(){delete e.errorMessage},e.save=function(n){n=n||{};var a=D(e.formSchema,angular.copy(e.record),0);e.record._id?r.post("api/"+e.modelName+"/"+e.id,a).success(function(t){t.success!==!1?n.redirect?window.location=n.redirect:(u=e.record,e.cancel()):S(t)}).error(x):r.post("api/"+e.modelName,a).success(function(r){r.success!==!1?n.redirect?window.location=n.redirect:t.path("/"+e.modelName+"/"+r._id+"/edit"):S(r)}).error(x)},e.new=function(){t.path("/"+e.modelName+"/new")},e.delete=function(){e.record._id&&r.delete("api/"+e.modelName+"/"+e.id),t.path("/"+e.modelName)},e.isCancelDisabled=function(){return angular.equals(u,e.record)},e.isSaveDisabled=function(){return e.myForm.$invalid||angular.equals(u,e.record)},e.disabledText=function(n){var t="";return e.isSaveDisabled&&(t="This button is only enabled when the form is complete and valid.  Make sure all required inputs are filled in. "+n),t},e.add=function(n){var t,r=n.field.name,a=r.split(".");t=e.record;for(var i=0,o=a.length;o>i;i++)t[a[i]]||(t[a[i]]=i===o-1?[]:{}),t=t[a[i]];t.push({})},e.remove=function(n,t){for(var r=n.$parent.field.name,a=r.split("."),i=e.record,o=0,s=a.length;s>o;o++)i=i[a[o]];i.splice(t,1)};var N=function(n,t,r){for(var a=0;n.length>a;a++){var i=n[a].name.slice(r);if(n[a].schema){if(t[i])for(var o=0;t[i].length>o;o++)t[i][o]=N(n[a].schema,t[i][o],r+1+i.length)}else{if(n[a].array&&"text"==n[a].type&&t[i])for(var s=0;t[i].length>s;s++)t[i][s]={x:t[i][s]};var c=e[p(n[a],"_ids")];c&&c.length>0&&t[i]?t[i]=l(n[a],t[i],e[p(n[a],"Options")],c):n[a].select2&&!n[a].select2.fngAjax&&(t[i]={id:-1,text:t[i]})}}return t},D=function(n,t,r){for(var a=0;n.length>a;a++){var i=n[a].name.slice(r);if(n[a].schema){var s=e.getListData(t,i);if(s)for(var l=0;s.length>l;l++)s[l]=D(n[a].schema,s[l],r+1+i.length)}else{if(n[a].array&&"text"==n[a].type&&t[i])for(var u=0;t[i].length>u;u++)t[i][u]=t[i][u].x;var d=e[p(n[a],"_ids")];d&&d.length>0?o(i,t,function(t){return c(n[a],t,e[p(n[a],"Options")],d)}):n[a].select2&&(n[a].select2.fngAjax?t[i]&&(t[i]=t[i].id):null===t[i]?delete t[i]:t[i]=t[i].text)}}return t},C=function(e,n,t,r){var a=n.indexOf(e);if(-1===a)throw Error("convertIdToListValue: Invalid data - id "+e+" not found in "+n+" processing "+r);return t[a]},k=function(e,n,t,r){var a=n.indexOf(e);if(-1===a)throw Error("convertListValueToId: Invalid data - value "+e+" not found in "+n+" processing "+r);return t[a]},O=function(n,t){var a=e[t.options]=[],i=e[t.ids]=[];r.get("api/schema/"+n).success(function(e){var o=[];w("Lookup "+n,e,null,o,"",!1),r.get("api/"+n,{cache:!1}).success(function(e){if(e){for(var n=0;e.length>n;n++){for(var r="",s=0;o.length>s;s++)r+=e[n][o[s].name]+" ";r=r.trim();var l=_.sortedIndex(a,r);a.splice(l,0,r),i.splice(l,0,e[n]._id)}q(t)}})})},q=function(n){if(!angular.equals(u[n.name],e.record[n.name]))throw Error("Cannot convert lookup values in changed record");o(n.name,u,function(t){return l(n,t,e[p(n,"Options")],e[p(n,"_ids")])}),e.record=angular.copy(u)};e.openSelect2=function(e){$("#"+$(e.currentTarget).data("select2-open")).select2("open")}}]),formsAngular.controller("ModelCtrl",["$scope","$http","$location",function(e,n,t){e.models=[],n.get("api/models").success(function(n){e.models=n}).error(function(){t.path("/404")})}]),formsAngular.controller("searchCtrl",["$scope","$http",function(e,n){e.results=[],e.moreCount=0,e.$watch("searchTarget",function(t){t&&t.length>0?n.get("api/search?q="+t).success(function(n){e.results=n.results,e.moreCount=n.moreCount,e.errorClass=0===e.results.length?"error":""}).error(function(){console.log("Error in searchbox.js")}):(e.errorClass="",e.results=[])},!0),e.$on("$routeChangeStart",function(){e.searchTarget=""})}]),formsAngular.directive("formInput",["$compile",function(e){return{restrict:"E",replace:!0,priority:1,compile:function(){return function(n,t,r){n.$watch(r.formInput,function(){var a=function(e,a,i,o){var l="",c="";if(!a)if(-1!=e.name.indexOf(".")&&-1!=t[0].outerHTML.indexOf('schema="true"')){var u=e.name,d=u.lastIndexOf(".");a="record."+u.slice(0,d)+"."+n.$parent.$index+"."+u.slice(d+1),o=a.replace(/\./g,"-")}else a=(r.model||"record")+"."+e.name,0===n.$index&&(l="autofocus ");var f,p=i||e.required?" required":"";if("select"==e.type)e.placeHolder&&(c='data-placeholder="'+e.placeHolder+'" '),e.select2&&e.select2.fngAjax?(f='<div class="input-append">',f+='<input ui-select2="'+e.select2.fngAjax+'" '+l+c+'ng-model="'+a+'" id="'+o+'" name="'+o+'" class="fng-select2">',f+='<button class="btn" type="button" data-select2-open="'+o+'" ng-click="openSelect2($event)"><i class="icon-search"></i></button>',f+="</div>"):e.select2?f='<input ui-select2="'+e.select2.s2query+'" '+l+c+'ng-model="'+a+'" id="'+o+'" name="'+o+'" class="fng-select2">':(f="<select "+l+'ng-model="'+a+'" id="'+o+'" name="'+o+'">',i||(f+="<option></option>"),f+='<option ng-repeat="option in '+e.options+'">{{option}}</option>',f+="</select>");else{var m=e.placeHolder?'placeholder="'+e.placeHolder+'" ':"";f="textarea"==e.type?"<textarea "+l+m+(e.rows?'rows = "'+e.rows+'" ':"")+'ng-model="'+a+'"'+(o?' id="'+o+'" name="'+o+'"':"")+p+(e.add?e.add:"")+" />":"<input "+l+m+'type="'+s.type+'" ng-model="'+a+'"'+(o?' id="'+o+'" name="'+o+'"':"")+p+(e.add?e.add:"")+"/>"}return e.helpInline&&(f+='<span class="help-inline">'+e.helpInline+"</span>"),e.help&&(f+='<span class="help-block">'+e.help+"</span>"),f},i=function(e,n){var t="";return(""!==e.label||n)&&(t='<label class="control-label" for="'+e.id+'">'+e.label+(n||"")+"</label>"),t},o=function(e){var t='<div class="control-group" id="cg_'+e.id+'">';if(e.schema){var o;o=n.formSchema[n.$index]&&e.id===n.formSchema[n.$index].id?"field in formSchema["+n.$index+"].schema":"field in panes["+n.$parent.$index+"].content["+n.$index+"].schema",t+='<div class="schema-head well">'+e.label+"</div>"+'<div class="sub-doc well" id="'+e.id+'List" ng-subdoc-repeat="subDoc in record.'+e.name+'">'+'<div class="row-fluid">'+'<div class="pull-left">'+'<form-input ng-repeat="'+o+'" info="{{field}}" schema="true"></form-input>'+"</div>"+'<div class="pull-left sub-doc-btns">'+'<button id="remove_'+e.id+'_btn" class="btn btn-mini form-btn" ng-click="remove(this,$index)">'+'<i class="icon-minus"></i> Remove'+"</button>"+"</div> "+"</div>"+"</div>"+'<div class = "schema-foot well">'+'<button id="add_'+e.id+'_btn" class="btn btn-mini form-btn" ng-click="add(this)">'+'<i class="icon-plus"></i> Add'+"</button>"+"</div>"}else t+=e.array?i(e,' <i id="add_'+e.id+' " ng-click="add(this)" class="icon-plus-sign"></i>')+'<div class="controls" id="'+e.id+'List" ng-repeat="arrayItem in record.'+e.name+'">'+a(e,"arrayItem.x",!0,null)+'<i ng-click="remove(this,$index)" class="icon-minus-sign"></i>'+"</div>":i(e)+'<div class="controls">'+a(e,null,r.required,e.id)+"</div>";return t+="</div>"},s=JSON.parse(r.info);if(s.directive){for(var l="<"+s.directive,c=t[0],u=0;c.attributes.length>u;u++){var d=c.attributes[u];switch(d.nodeName){case"ng-repeat":break;case"class":var f=d.nodeValue.replace("ng-scope","");f.length>0&&(l+=' class="'+f+'"');break;case"info":var p=JSON.parse(d.nodeValue);delete p.directive,l+=' info="'+JSON.stringify(p).replace(/\"/g,"&quot;")+'"';break;default:l+=" "+d.nodeName+'="'+d.nodeValue+'"'}}l+="></"+s.directive+">",t.replaceWith(e(l)(n))}else{var m=o(s);t.replaceWith(e(m)(n))}n.updateDataDependentDisplay&&n.updateDataDependentDisplay(n.record,null,!0)})}}}}]).directive("formButtons",["$compile",function(e){return{restrict:"A",compile:function(){return function(n,t){var r='<div class="btn-group pull-right"><button id="saveButton" class="btn btn-mini btn-primary form-btn" ng-click="save()" ng-disabled="isSaveDisabled()"><i class="icon-ok"></i> Save</button><button id="cancelButton" class="btn btn-mini btn-warning form-btn" ng-click="cancel()" ng-disabled="isCancelDisabled()"><i class="icon-remove"></i> Cancel</button></div><div class="btn-group btn-group pull-right"><button id="newButton" class="btn btn-mini btn-success form-btn" ng-click="new()"><i class="icon-plus"></i> New</button><button id="deleteButton" class="btn btn-mini btn-danger form-btn" ng-click="delete()"><i class="icon-minus"></i> Delete</button></div>';t.replaceWith(e(r)(n))}}}}]).directive("ngSubdocRepeat",[function(){return{transclude:"element",priority:1e3,terminal:!0,compile:function(e,n,t){return function(e,n,r){var a,i,o,s,l=r.ngSubdocRepeat,c=l.match(/^\s*(.+)\s+in\s+(.*)\s*$/);if(!c)throw Error("Expected ngSubdocRepeat in form of '_item_ in _collection_' but got '"+l+"'.");if(a=c[1],i=c[2],c=a.match(/^(?:([\$\w]+)|\(([\$\w]+)\s*,\s*([\$\w]+)\))$/),!c)throw Error("'item' in 'item in collection' should be identifier or (key, value) but got '"+a+"'.");o=c[3]||c[1],s=c[2];var u=[];e.$watch(function(e){var r,a,l,c,d,f,p,m,h=e.$eval(i),v=n,g=[];if(angular.isArray(h))p=h||[];else{p=[];for(d in h)h.hasOwnProperty(d)&&"$"!=d.charAt(0)&&p.push(d);p.sort()}for(l=p.length,r=0,a=p.length;a>r;r++)d=h===p?r:p[r],f=h[d],m=u.shift(),m?(c=m.scope,g.push(m),v=m.element):c=e.$new(),c[o]=f,s&&(c[s]=d),c.$index=r,c.$first=0===r,c.$last=r===l-1,c.$middle=!(c.$first||c.$last),m||t(c,function(e){v.after(e),m={scope:c,element:v=e,index:r},g.push(m)});for(var b=0;u.length>b;b++)u[b].element.remove(),u[b].scope.$destroy();u=g})}}}}]),formsAngular.filter("titleCase",[function(){return function(e){return e.replace(/_/g," ").replace(/[A-Z]/g," $&").replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}}]);